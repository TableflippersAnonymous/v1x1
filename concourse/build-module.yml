---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: maven
    tag: 3-jdk-8

inputs:
- name: v1x1-source
- name: maven-config
  path: root/.m2

outputs:
- name: v1x1-module-target
  path: v1x1-target

params:
  V1X1_MODULE_PATH:

run:
  path: sh
  args:
  - -exc
  - |
    export HOME=$(pwd)/root
    export M2_HOME=$(pwd)/root/.m2
    sed -i -r "s/DEVELOPMENT-SNAPSHOT/git-$(cat v1x1-source/.git/refs/heads/master)/g" v1x1-source/pom.xml
    ( cd v1x1-source && mvn -s $M2_HOME/settings.xml -Dmaven.repo.local=$M2_HOME/repository -pl $V1X1_MODULE_PATH -DskipDocker deploy )
    cp v1x1-source/$V1X1_MODULE_PATH/target/v1x1-modules-*.jar v1x1-target/
    cp v1x1-source/$V1X1_MODULE_PATH/docker/* v1x1-target/