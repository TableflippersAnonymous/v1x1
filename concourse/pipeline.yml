resource_types:
  - name: kubernetes
    type: docker-image
    source:
      repository: naomi/concourse-kubernetes-resource

resources:
  - name: v1x1-source
    type: git
    source:
      uri: git@github.com:LegionServers/v1x1.git
      branch: master
      private_key: ((v1x1.v1x1-deploy-key))
  - name: kubernetes
    type: kubernetes
    source:
      cluster_url: https://k8s-master.tblflp.zone
      namespace: v1x1
      username: circleci
      password: ((v1x1.kube-pass))
  - name: v1x1-web
    type: s3
    source:
      bucket: v1x1-web
      access_key_id: ((v1x1.aws-access-key))
      secret_access_key: ((v1x1.aws-secret-key))
      regexp: (.*)

  - name: v1x1-base
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-base
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))

  # Channel Modules:
  - name: v1x1-caster
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-caster
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-echo
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-echo
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-factoids
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-factoids
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-hello_world
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-hello_world
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-link_purger
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-link_purger
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-quotes
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-quotes
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-timed_messages
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-timed_messages
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-uptime
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-uptime
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-wasm
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-wasm
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))

  # Core Modules:
  - name: v1x1-api
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-api
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-chat_router
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-chat_router
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-cli
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-cli
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-event_router
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-event_router
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-scheduler
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-scheduler
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-tmi
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-tmi
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))
  - name: v1x1-discord
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-discord
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))

  # Global Modules:
  - name: v1x1-ops_tool
    type: docker-image
    source:
      repository: registry.tblflp.zone:5443/v1x1-ops_tool
      username: tblflp
      password: ((v1x1.docker-pass))
      ca_certs:
      - domain: registry.tblflp.zone:5443
        cert: ((v1x1.docker-ca))


jobs:
  - name: v1x1-common
    plan:
      - get: v1x1-source
        trigger: true
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-common.yml

  - name: v1x1-base
    plan:
      - get: v1x1-source
        trigger: true
      - put: v1x1-base
        params:
          build: v1x1-source/docker
          build_args:
            APP_ENV: prod
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true

  - name: v1x1-caster
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-caster
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-caster
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-caster-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-caster]
        trigger: true
      - put: kubernetes
        params:
          resource_name: caster
          image_name: registry.tblflp.zone:5443/v1x1-caster
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: caster

  - name: v1x1-echo
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-echo
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-echo
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-echo-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-echo]
        trigger: true
      - put: kubernetes
        params:
          resource_name: echo
          image_name: registry.tblflp.zone:5443/v1x1-echo
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: echo

  - name: v1x1-factoids
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-factoids
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-factoids
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-factoids-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-factoids]
        trigger: true
      - put: kubernetes
        params:
          resource_name: factoids
          image_name: registry.tblflp.zone:5443/v1x1-factoids
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: factoids

  - name: v1x1-hello_world
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-hello_world
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-hello_world
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-hello_world-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-hello_world]
        trigger: true
      - put: kubernetes
        params:
          resource_name: hello-world
          image_name: registry.tblflp.zone:5443/v1x1-hello_world
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: hello-world

  - name: v1x1-link_purger
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-link_purger
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-link_purger
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-link_purger-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-link_purger]
        trigger: true
      - put: kubernetes
        params:
          resource_name: link-purger
          image_name: registry.tblflp.zone:5443/v1x1-link_purger
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: link-purger

  - name: v1x1-quotes
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-quotes
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-quotes
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-quotes-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-quotes]
        trigger: true
      - put: kubernetes
        params:
          resource_name: quotes
          image_name: registry.tblflp.zone:5443/v1x1-quotes
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: quotes

  - name: v1x1-timed_messages
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-timed_messages
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-timed_messages
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-timed_messages-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-timed_messages]
        trigger: true
      - put: kubernetes
        params:
          resource_name: timed-messages
          image_name: registry.tblflp.zone:5443/v1x1-timed_messages
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: timed-messages

  - name: v1x1-uptime
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-uptime
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-uptime
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-uptime-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-uptime]
        trigger: true
      - put: kubernetes
        params:
          resource_name: uptime
          image_name: registry.tblflp.zone:5443/v1x1-uptime
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: uptime

  - name: v1x1-wasm
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-channel/v1x1-modules-channel-wasm
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-wasm
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-wasm-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-wasm]
        trigger: true
      - put: kubernetes
        params:
          resource_name: wasm
          image_name: registry.tblflp.zone:5443/v1x1-wasm
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: wasm

  - name: v1x1-api
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-api
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-api
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-api-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-api]
        trigger: true
      - put: kubernetes
        params:
          resource_name: api
          image_name: registry.tblflp.zone:5443/v1x1-api
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: api

  - name: v1x1-chat_router
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-chat_router
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-chat_router
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-chat_router-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-chat_router]
        trigger: true
      - put: kubernetes
        params:
          resource_name: chat-router
          image_name: registry.tblflp.zone:5443/v1x1-chat_router
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: chat-router

  - name: v1x1-cli
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-cli
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-cli
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true

  - name: v1x1-event_router
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-event_router
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-event_router
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-event_router-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-event_router]
        trigger: true
      - put: kubernetes
        params:
          resource_name: event-router
          image_name: registry.tblflp.zone:5443/v1x1-event_router
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: event-router

  - name: v1x1-scheduler
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-scheduler
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-scheduler
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-scheduler-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-scheduler]
        trigger: true
      - put: kubernetes
        params:
          resource_name: scheduler
          image_name: registry.tblflp.zone:5443/v1x1-scheduler
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: scheduler

  - name: v1x1-tmi
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-tmi
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-tmi
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-tmi-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-tmi]
        trigger: true
      - put: kubernetes
        params:
          resource_name: tmi
          image_name: registry.tblflp.zone:5443/v1x1-tmi
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: tmi
  - name: v1x1-discord
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-core/v1x1-modules-core-discord
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-discord
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-discord-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-discord]
        trigger: true
      - put: kubernetes
        params:
          resource_name: discord
          image_name: registry.tblflp.zone:5443/v1x1-discord
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: discord

  - name: v1x1-ops_tool
    plan:
      - aggregate:
        - get: v1x1-source
          passed: [v1x1-common, v1x1-base]
          trigger: true
        - get: v1x1-base
          params:
            save: true
          passed: [v1x1-base]
      - task: prep-maven
        file: v1x1-source/concourse/prep-maven.yml
        params:
          NEXUS_PASSWORD: ((v1x1.nexus-pass))
      - task: build
        file: v1x1-source/concourse/build-module.yml
        params:
          V1X1_MODULE_PATH: v1x1-modules/v1x1-modules-global/v1x1-modules-global-ops_tool
      - task: prep-docker
        file: v1x1-source/concourse/prep-docker.yml
      - put: v1x1-ops_tool
        params:
          build: v1x1-module-target
          load_base: v1x1-base-output
          tag: v1x1-source/.git/refs/heads/master
          tag_as_latest: true
        get_params:
          skip_download: true
  - name: v1x1-ops_tool-deploy
    plan:
      - get: v1x1-source
        passed: [v1x1-ops_tool]
        trigger: true
      - put: kubernetes
        params:
          resource_name: ops-tool
          image_name: registry.tblflp.zone:5443/v1x1-ops_tool
          image_tag: v1x1-source/.git/refs/heads/master
        get_params:
          resource_name: ops-tool

  - name: v1x1-web
    plan:
      - get: v1x1-source
        trigger: true
      - task: build
        file: v1x1-source/concourse/build-web.yml
      - aggregate:
        - put: v1x1-web
          params:
            file: v1x1-web-target/app.*.js
            content_type: application/javascript
        - put: v1x1-web
          params:
            file: v1x1-web-target/vendor.*.js
            content_type: application/javascript
        - put: v1x1-web
          params:
            file: v1x1-web-target/app.*.css
            content_type: text/css
        - put: v1x1-web
          params:
            file: v1x1-web-target/vendor.*.css
            content_type: text/css
        - put: v1x1-web
          params:
            file: v1x1-web-target/*.html
            content_type: text/html
      - task: invalidate
        file: v1x1-source/concourse/invalidate-cloudfront.yml
        params:
          AWS_ACCESS_KEY_ID: ((v1x1.aws-access-key))
          AWS_SECRET_ACCESS_KEY: ((v1x1.aws-secret-key))
